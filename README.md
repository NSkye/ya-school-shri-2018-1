# Задание 1 — найди ошибки

В этом репозитории находятся материалы тестового задания "Найди ошибки" для [14-й Школы разработки интерфейсов](https://academy.yandex.ru/events/frontend/shri_msk-2018-2) (осень 2018, Москва, Санкт-Петербург, Симферополь).

Для работы тестового приложения нужен Node.JS v9. В проекте используются [Yandex Maps API](https://tech.yandex.ru/maps/doc/jsapi/2.1/quick-start/index-docpage/) и [ChartJS](http://www.chartjs.org).

## Ход решения и найденные ошибки

1. [Неправильный импорт модуля initMap](#issue1)
1. [Родительский элемент карты нулевого размера](#issue2)
1. [На карте не отображается ни одной точки](#issue3)
1. [Для точек неправильно указывается широта и долгота](#issue4)
1. [Иконки кластеров не показывают, что в них есть неисправные станции](#issue5)
1. [По клику не показываются попапы](#issue6)
1. [Попап: не отображается график](#issue7)
1. [Попап: не отображается широта и долгота](#issue71)
+ [Примечания](#aside)

  

<a id="issue1" href=""></a>
### 1. Неправильный импорт модуля initMap
Во время первого запуска был обнаружен просто белый экран. Первой мыслью было проверить консоль, чтоб проверить наличие наиболее очевидных ошибок. Консоль говорила о том, что неправильно производится импортирование модуля initMap.

#### Причины возникновения
Синтаксическая ошибка. При импортировании модуля initMap вокруг его названия нет фигурных скобок. Хоть так и можно импортировать модули, но только когда в файле из которого он импортируется есть экспортируемый по умолчанию модуль:

```javascript
import initMap from "./map"; //не будет работать
import { initMap } from "./map"; //будет работать
```
#### Возможные пути исправления
##### 1. Добавить фигурные скобки в импортирующем модуле:
```javascript
import { initMap } from "./map";
```
##### 2. Экспортировать функцию initMap с ключевым словом default
```javascript
export default function initMap(ymaps, containerId) { /* ... */ }
```
Ради поддержания единого стиля кода я решил выбрать первый.
<a id="issue2" href=""></a>
### 2. Родительский элемент карты нулевого размера
После исправления первой ошибки всё ещё был белый экран, но консоль при этом говорила о том, что карта инициализирована. Поэтому я проверил страницу через инспектор: элемент, внутри которого находилась карта, имел нулевую высоту:
#### Причины возникновения
Ну... нулевая высота у элемента = ничего не видно. Карта должна находиться внутри элемента с ненулевым размером, это даже в доках написано было (как я потом увидел).
#### Пути исправления
Просто проставить высоту руту карты:
```css
#map {
  margin: 0;
  padding: 0;
  width: 100vw; //
  height: 100vh; // Вот тут
}
```
<a id="issue3" href=""></a>
### 3. На карте не отображается ни одной точки
После исправления первых двух ошибок карта корректно отображается, но всё ещё без точек. Проверяем документацию.
#### Причины возникновения и исправление
Геообъекты создаются и добавляются в менеджер объектов, но чтобы они были видны на карте, они должны быть также добавлены на карту:
```javascript
loadList().then(data => {
    objectManager.add(data);
    myMap.geoObjects.add(objectManager); //Для добавления объектов на карту тут не хватало этой строчки
  });
```
<a id="issue4" href=""></a>
### 4. Для точек неправильно указывается широта и долгота
Вот это довольно неплохо сконфузило меня. Я не понимал сначала почему точки всё ещё не видны. Логировал функции связанные с ними, чтоб увидеть, что нужные функции запускаются, и им передаются нужные аргументы. Затем отошел попить чаю и пока пил чай в голову пришла мысль, что может точки где-то в другом месте на карте, мало ли. После чего я отдалил карту и да, я увидел станции дронов в Иране.
#### Причины возникновения
Ну это можно по-разному трактовать. Либо карта зумится не в то место, либо точки ставятся не туда. Но как ни трактуй, проблема в любом случае возникает из-за того, что на одном из этапов широта и долгота меняются местами.
#### Исправление
Вполне очевидно, что это точки ставятся не туда, потому что в генераторе данных всем точкам явно задаются координаты в пределах Москвы. Раз генератор нам кидает правильные данные, значит приложение ломает их где-то на этапе обработки. В приложении есть только одна функция, которая затрагивает координаты - `mapServerData`, которая преобразует данные с сервера в геообъекты, которые понимают Яндекс.Карты. Соответственно, там и надо смотреть, там и находим ошибку и исправляем путем выставления их в правильном порядке (широта всегда ставится первой).
```javascript
export function mapServerData(serverData) {
  return {
    type: "FeatureCollection",
    features: serverData.map((obj, index) => ({
      id: index,
      type: "Feature",
      isActive: obj.isActive,
      geometry: 
      {
        type: "Point",
        coordinates: [obj.lat, obj.long] //тут координаты менялись местами
      },
      properties: {
        iconCaption: obj.serialNumber
      },
      options: {
        preset: getObjectPreset(obj)
      }
    }))
  };
}
```
<a id="issue5" href=""></a>
### 5. Иконки кластеров не показывают, что в них есть неисправные станции
Ура, наконец отображаются все точки и они даже в нужном месте. Но в задании есть ещё несколько условий. Соответственно, принимаемся за реализацию первого из них.
#### Причины возникновения
Все кластеры окрашиваются в зеленый цвет и всё.
```javascript
objectManager.clusters.options.set('preset', 'islands#greenClusterIcons');
```
#### Возможные пути исправления
##### 1. Написать логику покраски кластеров:
В задании не сказано как именно иконка кластера должна показывать, что в нем есть неисправная станция. Но в целом для меня логично, что если зеленый кластер содержит все рабочие станции, то кластер, содержащий несколько нерабочих должен быть оранжевым (ну и дополнительно кластеры со всеми нерабочими можно окрашивать красным).
В общем, немного читаем документацию карт и реализуем покраску кластеров. Алгоритм следующий:
1. Ставим прослушку события создания нового кластера  
Когда добавляется новый кластер:  
2. Назначаем для него зеленый цвет
3. Итерируем через все его геообъекты и считаем неактивные
4. Если в процессе подсчета обнаруживается неактивный объект, то назначаем оранжевый цвет
5. Сравниваем число неактивных объектов с количеством объектов в кластере
6. Если числа равны, то назначаем кластеру красный цвет
7. Выставляем кластеру цвет иконки, который мы вычислили
```javascript
objectManager.clusters.events.add('add', function (e) {
    const cluster = objectManager.clusters.getById(e.get('objectId')); //узнаем что у нас за кластер
    const objects = cluster.properties.geoObjects; //получаем все объекты кластера
    let preset = 'islands#greenClusterIcons'; //ставим по умолчанию зеленый цвет
    const inactiveObjsCount = objects.reduce((ac, cv) => //итерируем через все объекты, одновременно считая неактивные
      cv.isActive ? ac : ~(preset = 'islands#orangeClusterIcons') && ac+1, 0 //если объект дефективен, то ставим оранжевый цвет
    )
    if (objects.length == inactiveObjsCount) { //если количество неактивных объектов = количеству объектов в кластере
      //делаем кластер красным
      preset = 'islands#redClusterIcons';
    }
    objectManager.clusters.setClusterOptions(cluster.id, { preset }); //выставляем цвет кластера
});
```
*Примечание: бинарное НЕ (~) тут по сути не нужно, но мне привычно его использовать в этом контексте, чтобы быть уверенным, что выражение всегда (кроме как когда оно -1, чего тут быть не может) вернет truthy значение.*
##### 2. Просто удалить фрагмент кода, который окрашивает все кластеры в зеленый
По умолчанию иконки кластеров формируются на основании цветов группируемых иконок, поэтому, если мы просто удалим нижеприведенную строчку, то кластеры будут в виде красивого графика отображать доли работающих и неработающих станций внутри себя.
```javascript
objectManager.clusters.options.set('preset', 'islands#greenClusterIcons'); // удалить это
```
<a id="issue6" href=""></a>
### 6. По клику не показываются попапы
Единственной оставшейся на этом этапе проблемой было отсутствие отображение попапов. В изначально предоставленном приложении присутствует два модуля, которые предполагаемо отвечают за вывод попапов: details.js и popup.js. popup.js никуда не импортируется и ни в каком месте не обращается к модулю chart.js, отвечающему за построение графиков, кроме того, в нем фигурируют переменные, которые нам не предоставляются сервером, такие как obj.id, obj.operator и obj.drones, в общем, он выглядит так, будто он вообще не отсюда. Поэтому далее процесс решения проблемы шел исходя из предположения, что нам нужен только (или как минимум в первую очередь), модуль details.js.
#### Причины возникновения
Причины оказались достаточно тривиальными. Из-за использования стрелочных функций в модуле getDetailsContentLayout, this не ссылался на нужный нам объект:
```javascript
/* ... */
build: () => {
        BalloonContentLayout.superclass.build.call(this); //уже тут всё сломается

        const { details } = this.getData().object.properties;

        if (details) {
          const container = this.getElement().querySelector('.details-chart');

          this.connectionChart = createChart(
            container,
            details.chart,
            details.isActive
          );
        }
},
/* ... */
```
#### Исправление
Поменять стрелочные функции на обычные (собственно, в таком виде и приведены примеры в документации):
```javascript
/* ... */
build: function() {
        BalloonContentLayout.superclass.build.call(this); //теперь всё работает правильно

        const { details } = this.getData().object.properties;

        if (details) {
          const container = this.getElement().querySelector('.details-chart');

          this.connectionChart = createChart(
            container,
            details.chart,
            details.isActive
          );
        }
},
/* ... */
```
Теперь, когда мы видим, что всё работает правильно, мы понимаем, что popup.js нам просто не нужен и удаляем его.
<a id="issue7" href=""></a>
### 7. Попап: не отображается график
Теперь попапы появляются как надо, но график в них не работает. Убедившись, что функция для создания графиков получает все нужные данные, проверяем её внимательней.
#### Причины возникновения
Я было уже полез в документацию chart.js, но все оказалось очень просто. Заметив, что только у неактивных станций график хоть что-то отображает и при этом только какие-то значения в конце, я примерно понял, где может быть проблема. Максимальное значение по оси Y выставлено на 0:
```javascript
/* ... */
const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(getLabel),
      datasets: [
        {
          data: data,
          borderWidth: 1,
            borderColor: borderColor,
              backgroundColor: backgroundColor
        }
      ]
    },
    options: {
        legend: { 
            display: false
        },
        scales: {
            xAxes: [{ ticks: { display: false } }],
            yAxes: [{ ticks: { beginAtZero: true, max: 0 } }] //вот тут
        }
    }
});
/* ... */
```
#### Возможные пути исправления
##### 1. Задать другое максимальное значение
Просто сделаем ненулевое значение. Пусть лучше максимальным значением графика будет максимальное значение в датасете, чтобы график выглядел красиво и пропорционально:
```javascript
/* ... */
const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(getLabel),
      datasets: [
        {
          data: data,
          borderWidth: 1,
            borderColor: borderColor,
              backgroundColor: backgroundColor
        }
      ]
    },
    options: {
        legend: { 
            display: false
        },
        scales: {
            xAxes: [{ ticks: { display: false } }],
            yAxes: [{ ticks: { beginAtZero: true, max: Math.max(...data) } }]
        }
    }
});
/* ... */
```
##### 2. Убрать максимальное значение вообще
```javascript
/* ... */
        scales: {
                    xAxes: [{ ticks: { display: false } }],
                    yAxes: [{ ticks: { beginAtZero: true } }]
/* ... */
```
Дело вкуса, конечно, мне первый вариант нравится больше. Практически не увеличивает количество кода, но графики красивее.
<a id="issue71" href=""></a>
### 8 Попап: не отображается широта и долгота
#### Причины возникновения
Этого функционала изначально просто не реализовано
#### Исправление
Добавляем ещё один элемент в шаблон:
```javascript
/* ... */
const BalloonContentLayout = ymaps.templateLayoutFactory.createClass(
    `<div class="details-info">
        {% if (properties.details) %}
            <div class="details-info">
                <div class="details-label">base station</div>
                <div class="details-title">{{properties.details.serialNumber}}</div>
<!--Вот тут-->  <div class="details-coordinates">lat: {{properties.details.lat}}, long: {{properties.details.long}}</div>
                {% if (properties.details.isActive) %}
                <div class="details-state details-state_active">active</div>
                {% else %}
                <div class="details-state details-state_defective">defective</div>
                {% endif %}
                <div class="details-state details-state_connections">
                    connections: {{properties.details.connections}}
                </div>
            </div>
            <div class="details-info">
                <div class="details-label">connections</div>
                <canvas class="details-chart" width="270" height="100" />
            </div>
        {% else %}
            <div class="details-info">
                Идет загрузка данных...
            </div>
        {% endif %}
    `,
/* ... */
```
Задаем ему немного стилей:
```css
.details-coordinates {
  font-size: 0.8em;
  font-weight: bold;
  padding-bottom: .4em;
}
```
Всё, теперь всё красиво!
<a id="aside" href=""></a>
### Примечания
Во время выполнения задания был использован очень простой самописный логгер, использование которого можно наблюдать, если посмотреть разные коммиты. Использовался для того чтоб увидеть, что вызываются нужные функции и они получают нужные аргументы. Конечно, можно было использовать более продвинутые инструменты для отладки и юнит-тесты, но даже этот логгер тут оказался по итогу довольно избыточным.
Сам логгер:
```javascript
export function logger (currentModule) {
    return function(txt, place, type ='info', other ) {
        const date = new Date(Date.now())
        const log = `[${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}.${date.getMilliseconds()}] ${type} [${place}] in [${currentModule}] ${txt}` + (other ? ('\n' + JSON.stringify(other)) : '');
        console.log(log);
    }
}
```
